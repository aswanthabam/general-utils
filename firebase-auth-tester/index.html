<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Auth Tester</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #1a202c;
        color: #e2e8f0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .modal {
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .modal.hidden {
        opacity: 0;
        visibility: hidden;
      }
      .modal-overlay {
        background-color: rgba(0, 0, 0, 0.75);
      }
    </style>
  </head>
  <body>
    <div
      class="max-w-4xl w-full mx-auto p-8 bg-gray-800 rounded-xl shadow-2xl relative"
    >
      <button
        id="settingsBtn"
        class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200"
      >
        <i class="fa-solid fa-cog text-2xl"></i>
      </button>

      <h1 class="text-3xl font-bold text-center mb-6 text-white">
        Firebase Authentication Tester
      </h1>

      <!-- Message Box -->
      <div
        id="message-box"
        class="hidden mb-4 p-4 rounded-lg text-sm"
        role="alert"
      ></div>

      <div class="space-y-6">
        <!-- Main Authentication Buttons -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button
            id="authGoogleBtn"
            class="w-full px-6 py-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-lg transition-transform duration-200 transform hover:scale-105 flex items-center justify-center space-x-2"
          >
            <i class="fa-brands fa-google text-lg"></i>
            <span>Google</span>
          </button>
          <button
            id="authAppleBtn"
            class="w-full px-6 py-4 bg-gray-900 hover:bg-black text-white font-semibold rounded-lg shadow-lg transition-transform duration-200 transform hover:scale-105 flex items-center justify-center space-x-2"
          >
            <i class="fa-brands fa-apple text-lg"></i>
            <span>Apple</span>
          </button>
          <button
            id="showEmailAuthBtn"
            class="w-full px-6 py-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-lg transition-transform duration-200 transform hover:scale-105 flex items-center justify-center space-x-2"
          >
            <i class="fa-solid fa-envelope text-lg"></i>
            <span>Email</span>
          </button>
        </div>

        <!-- Email & Password Inputs and Buttons -->
        <div id="emailAuthContainer" class="mt-8 space-y-4 hidden">
          <h2 class="text-xl font-bold text-white mb-4">
            Email & Password Auth
          </h2>
          <div>
            <label
              for="emailInput"
              class="block text-sm font-medium text-gray-400 mb-2"
              >Email</label
            >
            <input
              type="email"
              id="emailInput"
              class="block w-full px-4 py-3 bg-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200"
              placeholder="Enter email"
            />
          </div>
          <div>
            <label
              for="passwordInput"
              class="block text-sm font-medium text-gray-400 mb-2"
              >Password</label
            >
            <input
              type="password"
              id="passwordInput"
              class="block w-full px-4 py-3 bg-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-200"
              placeholder="Enter password"
            />
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button
              id="authEmailPasswordBtn"
              class="w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-lg transition-transform duration-200 transform hover:scale-105"
            >
              Sign In/Up
            </button>
            <button
              id="verifyEmailBtn"
              class="w-full px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg shadow-lg transition-transform duration-200 transform hover:scale-105"
            >
              Send Verification Email
            </button>
          </div>
        </div>

        <!-- Output for ID Token -->
        <div class="mt-8">
          <h2 class="text-xl font-bold text-white mb-4">
            Authenticated User ID Token
          </h2>
          <div class="relative">
            <textarea
              id="outputToken"
              rows="10"
              class="w-full p-4 pr-16 bg-gray-900 rounded-lg text-gray-300 font-mono text-sm break-words focus:outline-none"
              readonly
            >
Your ID token will appear here after successful login.</textarea
            >
            <button
              id="copyTokenBtn"
              class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200"
            >
              <i class="fa-solid fa-clipboard text-lg"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="modal fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div id="modalOverlay" class="modal-overlay absolute inset-0"></div>
      <div
        class="modal-content relative bg-gray-800 rounded-xl shadow-2xl p-8 max-w-lg w-full"
      >
        <button
          id="closeModalBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200"
        >
          <i class="fa-solid fa-times text-2xl"></i>
        </button>
        <h2 class="text-2xl font-bold text-white mb-6 text-center">
          Firebase Settings
        </h2>
        <div>
          <label
            for="firebaseConfig"
            class="block text-sm font-medium text-gray-400 mb-2"
            >Firebase Config Object</label
          >
          <textarea
            id="firebaseConfig"
            rows="8"
            class="block w-full px-4 py-3 bg-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
            placeholder="Paste your entire firebaseConfig object (including curly braces) from Firebase Project Settings..."
          ></textarea>
          <p class="text-xs text-gray-500 mt-2">
            The config will be saved locally in your browser.
          </p>
        </div>
        <button
          id="saveConfigBtn"
          class="w-full mt-6 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg transition-transform duration-200 transform hover:scale-105"
        >
          Save & Initialize
        </button>
      </div>
    </div>

    <!-- Firebase JS SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        GoogleAuthProvider,
        signInWithPopup,
        signInWithEmailAndPassword,
        sendEmailVerification,
        OAuthProvider,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      let auth;
      let app;
      let db;

      // UI elements
      const firebaseConfigInput = document.getElementById("firebaseConfig");
      const authGoogleBtn = document.getElementById("authGoogleBtn");
      const authAppleBtn = document.getElementById("authAppleBtn");
      const showEmailAuthBtn = document.getElementById("showEmailAuthBtn");
      const authEmailPasswordBtn = document.getElementById(
        "authEmailPasswordBtn"
      );
      const verifyEmailBtn = document.getElementById("verifyEmailBtn");
      const emailInput = document.getElementById("emailInput");
      const passwordInput = document.getElementById("passwordInput");
      const outputToken = document.getElementById("outputToken");
      const messageBox = document.getElementById("message-box");
      const copyTokenBtn = document.getElementById("copyTokenBtn");
      const settingsBtn = document.getElementById("settingsBtn");
      const settingsModal = document.getElementById("settingsModal");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const saveConfigBtn = document.getElementById("saveConfigBtn");
      const emailAuthContainer = document.getElementById("emailAuthContainer");

      function showMessage(message, type = "info") {
        let bgColor, textColor;
        if (type === "success") {
          bgColor = "bg-green-500";
          textColor = "text-green-900";
        } else if (type === "error") {
          bgColor = "bg-red-500";
          textColor = "text-red-900";
        } else {
          bgColor = "bg-blue-500";
          textColor = "text-blue-900";
        }
        messageBox.textContent = message;
        messageBox.className = `block mb-4 p-4 rounded-lg text-sm ${bgColor} ${textColor}`;
      }

      function initializeFirebase(config) {
        try {
          app = initializeApp(config);
          auth = getAuth(app);
          db = getFirestore(app);

          onAuthStateChanged(auth, async (user) => {
            if (user) {
              try {
                const idToken = await user.getIdToken();
                outputToken.value = idToken;
                showMessage(
                  `Signed in as ${
                    user.email || user.displayName || "a user"
                  }. ID Token retrieved successfully.`,
                  "success"
                );
              } catch (error) {
                showMessage(
                  `Error getting ID token: ${error.message}`,
                  "error"
                );
                console.error("Error getting ID token:", error);
              }
            } else {
              outputToken.value =
                "Your ID token will appear here after successful login.";
              showMessage("No user is currently signed in.");
            }
          });

          showMessage("Firebase initialized successfully!", "success");
        } catch (error) {
          showMessage(`Error initializing Firebase: ${error.message}`, "error");
          console.error("Initialization error:", error);
        }
      }

      // Load config from local storage on page load
      window.addEventListener("load", () => {
        const storedConfig = localStorage.getItem("firebaseConfig");
        if (storedConfig) {
          firebaseConfigInput.value = storedConfig;
          try {
            const config = eval("(" + storedConfig + ")");
            initializeFirebase(config);
          } catch (e) {
            showMessage(
              "Stored Firebase config is invalid. Please update it in settings.",
              "error"
            );
          }
        } else {
          showMessage(
            "Please enter your Firebase config in the settings to get started.",
            "info"
          );
        }
      });

      // Event listeners
      settingsBtn.addEventListener("click", () => {
        settingsModal.classList.remove("hidden");
      });

      closeModalBtn.addEventListener("click", () => {
        settingsModal.classList.add("hidden");
      });

      saveConfigBtn.addEventListener("click", () => {
        const configString = firebaseConfigInput.value.trim();
        if (configString) {
          localStorage.setItem("firebaseConfig", configString);
          try {
            const config = eval("(" + configString + ")");
            initializeFirebase(config);
            settingsModal.classList.add("hidden");
          } catch (e) {
            showMessage(
              "Invalid Firebase Config object. Please check the syntax.",
              "error"
            );
          }
        } else {
          showMessage("Please enter a config object.", "error");
        }
      });

      showEmailAuthBtn.addEventListener("click", () => {
        emailAuthContainer.classList.toggle("hidden");
      });

      authGoogleBtn.addEventListener("click", async () => {
        if (!auth) {
          showMessage(
            "Please initialize Firebase first using the settings button.",
            "error"
          );
          return;
        }
        try {
          const provider = new GoogleAuthProvider();
          showMessage("Opening Google sign-in pop-up...", "info");
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          const idToken = await user.getIdToken();
          outputToken.value = idToken;
          showMessage(
            `Sign-in successful for ${
              user.email || user.displayName
            }. ID Token retrieved.`,
            "success"
          );
        } catch (error) {
          showMessage(`Google Auth Error: ${error.message}`, "error");
          console.error("Google Auth Error:", error);
        }
      });

      authAppleBtn.addEventListener("click", async () => {
        if (!auth) {
          showMessage(
            "Please initialize Firebase first using the settings button.",
            "error"
          );
          return;
        }
        try {
          const provider = new OAuthProvider("apple.com");
          showMessage("Opening Apple sign-in pop-up...", "info");
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          const idToken = await user.getIdToken();
          outputToken.value = idToken;
          showMessage(
            `Sign-in successful for ${
              user.email || user.displayName
            }. ID Token retrieved.`,
            "success"
          );
        } catch (error) {
          showMessage(`Apple Auth Error: ${error.message}`, "error");
          console.error("Apple Auth Error:", error);
        }
      });

      authEmailPasswordBtn.addEventListener("click", async () => {
        if (!auth) {
          showMessage(
            "Please initialize Firebase first using the settings button.",
            "error"
          );
          return;
        }
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
          showMessage("Please enter both email and password.", "error");
          return;
        }

        try {
          await signInWithEmailAndPassword(auth, email, password);
          showMessage("Signed in with email/password.", "success");
        } catch (signInError) {
          if (
            signInError.code === "auth/user-not-found" ||
            signInError.code === "auth/wrong-password"
          ) {
            try {
              await createUserWithEmailAndPassword(auth, email, password);
              showMessage(
                "User created and signed in with email/password.",
                "success"
              );
            } catch (createError) {
              showMessage(
                `Error signing in/up with email: ${createError.message}`,
                "error"
              );
              console.error("Email/Password Auth Error:", createError);
            }
          } else {
            showMessage(
              `Error signing in with email: ${signInError.message}`,
              "error"
            );
            console.error("Email/Password Auth Error:", signInError);
          }
        }
      });

      verifyEmailBtn.addEventListener("click", async () => {
        if (!auth || !auth.currentUser) {
          showMessage("Please sign in with email/password first.", "error");
          return;
        }
        try {
          await sendEmailVerification(auth.currentUser);
          showMessage(
            "Verification email sent! Please check your inbox.",
            "success"
          );
        } catch (error) {
          showMessage(
            `Error sending verification email: ${error.message}`,
            "error"
          );
          console.error("Email verification error:", error);
        }
      });

      copyTokenBtn.addEventListener("click", async () => {
        const token = outputToken.value;
        if (
          token &&
          token !== "Your ID token will appear here after successful login."
        ) {
          try {
            // Use the modern Clipboard API
            await navigator.clipboard.writeText(token);
            showMessage("ID Token copied to clipboard!", "success");
          } catch (err) {
            // Fallback for older browsers
            const textarea = document.createElement("textarea");
            textarea.value = token;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            showMessage(
              "ID Token copied to clipboard! (using fallback method)",
              "success"
            );
          }
        } else {
          showMessage("No token to copy.", "error");
        }
      });
    </script>
  </body>
</html>
